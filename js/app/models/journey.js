!function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,o=function(t,o){function n(){this.constructor=t}for(var r in o)e.call(o,r)&&(t[r]=o[r]);return n.prototype=o.prototype,t.prototype=new n,t.__super__=o.prototype,t};define(["jquery","underscore","backbone","config","app/collections/waypoints","app/collections/steps","app/models/waypoint","app/models/weather_details","jquery.cookie"],function(e,n,r,i,a,s,p,l){var u,h;return u=function(r){function u(){return this.liveDrag=t(this.liveDrag,this),h=u.__super__.constructor.apply(this,arguments)}return o(u,r),u.prototype.defaults={mode:"walking",altitude_factor:1.13046330315024},u.prototype.initialize=function(){var t=this;return this.waypoints=new a,this.waypoints.journey=this,this.steps=new s,this.on("change:waypoints change:steps",function(){return t.waypoints.reset(t.get("waypoints")),t.steps.reset(t.get("steps"))}),this.on("change:elevation",function(){return t.set("pace",t.default_pace())}),this.on("sync",function(){return e("a[href='#results']").show().tab("show"),t.get("encoded_polyline")?t.updateMap():void 0}),this.on("live_drag",this.liveDrag)},u.prototype.validate=function(t){var e,o;return e=[],this.get("example")||(n(["walking","cycling"]).indexOf(t.mode)>=0||e.push(""+t.mode+" is not a valid mode"),o=this.waypoints.filter(function(t){return t.isValid()}),o.length>1||e.push("you need a minimum of two waypoints")),e.length>0?e:void 0},u.prototype.url=function(){var t;return t="mode="+this.get("mode"),this.waypoints.each(function(e){return t+="&"+e.queryStr()}),"http://www.journeyplanner.org.nz/api/route.json?"+t},u.prototype.parse=function(t){return t.success&&t.total>0?t.journeys[0]:void 0},u.prototype.weather_details=function(){var t;return t=this.steps.bounding_box().getCenter(),this._weather_details=new l({lat:t.lat(),lng:t.lng()}),this._weather_details.fetch(),this._weather_details},u.prototype.total_time=function(){return 60*(this.get("total_distance")/(1e3*this.currentSpeed()))},u.prototype.car_cost=function(){return i.CAR_COST[this.get("mode")]*(this.get("total_distance")/1e3)},u.prototype.health_cost=function(){return i.HEALTH_COST[this.get("mode")]*(this.get("total_distance")/1e3)},u.prototype.carbon_saving=function(){return.214*(this.get("total_distance")/1e3)},u.prototype.default_pace=function(){switch(this.get("mode")){case"walking":return this.elevation_change()>=.1?"slow":"average";case"cycling":return this.elevation_change()>=.03?"slow":this.elevation_change()<=-.05?"fast":"average"}},u.prototype.elevation_change=function(){var t,e;return null==this.get("elevation")?0:(e=n(this.get("elevation").data).first()[1],t=n(this.get("elevation").data).last()[1],(t-e)/this.get("total_distance"))},u.prototype.calculate_calories=function(t){return Math.round(t*this.total_time()*this.currentEffort()*this.get("altitude_factor"))},u.prototype.currentSpeed=function(){return i.SPEEDS[this.get("mode")][this.get("pace")]},u.prototype.currentEffort=function(){return i.EFFORT[this.get("mode")][this.get("pace")]},u.prototype.elevation_marker=function(){return this._elevation_marker||(this._elevation_marker=new google.maps.Marker({map:App.map,icon:this.elevation_icon()}))},u.prototype.elevation_icon=function(){return{anchor:new google.maps.Point(14,34),url:"img/elevation_markers/icon_"+this.get("mode")+".png"}},u.prototype.showElevationMarker=function(t){var e;return null==t&&(t=0),e=t*this.get("total_distance"),this.elevation_marker().setOptions({position:this.pointAlongPath(e),visible:!0})},u.prototype.hideElevationMarker=function(){return this.elevation_marker().setVisible(!1)},u.prototype.pointAlongPath=function(t){var e,o,n=this;return null==t&&(t=0),o=null,null!=this.polyline()&&(e=0,this.polyline().getPath().forEach(function(r,i){var a,s,p;if(i>0&&null===o){if(s=n.polyline().getPath().getAt(i-1),p=google.maps.geometry.spherical.computeDistanceBetween(s,r),!(e+p>t))return e+=p;a=(t-e)/p,o=google.maps.geometry.spherical.interpolate(s,r,a)}})),o},u.prototype.nearestPolylineNode=function(t){var e,o,n;return null!=this.polyline()?(n=this.polyline().getPath(),o=1/0,e=null,n.forEach(function(n){var r;return(r=google.maps.geometry.spherical.computeDistanceBetween(n,t))<o?(e=n,o=r):void 0}),n.getArray().indexOf(e)):void 0},u.prototype.preceedingWaypoint=function(t){var e,o,n=this;return o=null,e=this.nearestPolylineNode(t),this.waypoints.each(function(t){return n.nearestPolylineNode(t.getLatLng())<e?o=t:void 0}),o},u.prototype.showOverlays=function(t){var e,o;return null!=(e=this.polyline())&&e.setMap(t),null!=(o=this.ghostline())&&o.setMap(t),this.waypoints.each(function(e){return e.getMarker().setMap(t)})},u.prototype.hideOverlays=function(){var t;return null!=(t=this.shadow_live)&&t.setMap(null),this.showOverlays(null)},u.prototype.polyline=function(){return this.get("encoded_polyline")?null!=this._polyline?this._polyline:(this._polyline=new google.maps.Polyline({map:App.map,path:google.maps.geometry.encoding.decodePath(this.get("encoded_polyline").polyline),strokeColor:"#2564a5",strokeWeight:4,strokeOpacity:.7}),this._polyline):void 0},u.prototype.ghostline=function(){var t=this;return this.get("encoded_polyline")?null!=this._ghostline?this._ghostline:(this._ghostline=new google.maps.Polyline({map:App.map,path:google.maps.geometry.encoding.decodePath(this.get("encoded_polyline").polyline),strokeWeight:12,strokeOpacity:.1}),google.maps.event.addListener(this._ghostline,"mousemove",function(e){return t.dragMarker().setPosition(e.latLng),t.showDragMarker()}),google.maps.event.addListener(this._ghostline,"mouseout",function(){return t.hideDragMarker()}),this._ghostline):void 0},u.prototype.waypointMarkers=function(){return this.waypoints.map(function(t){var e;return e=t.getMarker()})},u.prototype.updateMap=function(){return null!=App.map?(App.map.fitBounds(this.steps.bounding_box()),this.showOverlays(App.map)):void 0},u.prototype.dragWaypoint=function(){return this._drag_waypoint||(this._drag_waypoint=new p({type:"live_drag"}))},u.prototype.dragMarker=function(){var t=this;return null!=this._drag_marker?this._drag_marker:(this._drag_marker=this.dragWaypoint().getMarker(),this._drag_marker.setOptions({map:App.map,draggable:!0,visible:!1,title:"Drag line to adjust route"}),google.maps.event.addListener(this._drag_marker,"mouseover",function(){return t.showDragMarker()}),google.maps.event.addListener(this._drag_marker,"mousedown",function(){return t._drag_marker.set("live_drag",!0)}),google.maps.event.addListener(this._drag_marker,"mouseup",function(){return t._drag_marker.set("live_drag",!1)}),google.maps.event.addListener(this._drag_marker,"dragstart",function(e){var o;return o=t.waypoints.indexOf(t.preceedingWaypoint(e.latLng)),t.waypoints.add(t.dragWaypoint(),{at:o+1})}),this._drag_marker)},u.prototype.showDragMarker=function(){return this.dragMarker().setOptions({visible:!0})},u.prototype.hideDragMarker=function(){return this.dragMarker().get("live_drag")?void 0:this.dragMarker().setOptions({visible:!1})},u.prototype.liveDrag=function(){var t,o=this;return t=this.waypoints.map(function(t){return{x:t.getMarker().getPosition().lng(),y:t.getMarker().getPosition().lat()}}),e.getJSON("http://www.journeyplanner.org.nz/api/route/shadow.json",{waypoints:t,mode:this.get("mode")},function(t){var e;return null!=(e=o.shadow_live)&&e.setMap(null),null!=t.encoded_polyline?o.shadow_live=new google.maps.Polyline({map:App.map,path:google.maps.geometry.encoding.decodePath(t.encoded_polyline.polyline),strokeColor:"#2564a5",strokeWeight:4,strokeOpacity:.4}):void 0})},u}(r.Model)})}.call(this);
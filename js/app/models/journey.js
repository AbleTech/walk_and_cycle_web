!function(){var t={}.hasOwnProperty,e=function(e,o){function n(){this.constructor=e}for(var r in o)t.call(o,r)&&(e[r]=o[r]);return n.prototype=o.prototype,e.prototype=new n,e.__super__=o.prototype,e};define(["jquery","underscore","backbone","config","app/collections/waypoints","app/collections/steps","jquery.cookie"],function(t,o,n,r,i,p){var a,s;return a=function(n){function a(){return s=a.__super__.constructor.apply(this,arguments)}return e(a,n),a.prototype.defaults={mode:"walking",altitude_factor:1.13046330315024},a.prototype.initialize=function(){var e=this;return this.waypoints=new i,this.waypoints.journey=this,this.steps=new p,this.set("pace",t.cookie("jp_speed")||"average"),this.on("change",function(){return e.waypoints.reset(e.get("waypoints")),e.steps.reset(e.get("steps"))}),this.on("change:pace",function(){return t.cookie("jp_speed",e.get("pace"),{path:"/",expires:365})}),this.on("sync",function(){return e.get("encoded_polyline")&&e.updateMap(),t("a[href='#results']").show().tab("show")})},a.prototype.validate=function(t){var e,n;return e=[],this.get("example")||(o(["walking","cycling"]).indexOf(t.mode)>=0||e.push(""+t.mode+" is not a valid mode"),n=this.waypoints.filter(function(t){return t.isValid()}),n.length>1||e.push("you need a minimum of two waypoints")),e.length>0?e:void 0},a.prototype.url=function(){var t;return t="mode="+this.get("mode"),this.waypoints.each(function(e){return t+="&"+e.queryStr()}),"http://staging.journeyplanner.org.nz/api/route.json?callback=?&"+t},a.prototype.parse=function(t){return t.success&&t.total>0?t.journeys[0]:void 0},a.prototype.total_time=function(){return 60*(this.get("total_distance")/(1e3*this.currentSpeed()))},a.prototype.car_cost=function(){return r.CAR_COST[this.get("mode")]*(this.get("total_distance")/1e3)},a.prototype.health_cost=function(){return r.HEALTH_COST[this.get("mode")]*(this.get("total_distance")/1e3)},a.prototype.carbon_saving=function(){return.214*(this.get("total_distance")/1e3)},a.prototype.calculate_calories=function(t){return Math.round(t*this.total_time()*this.currentEffort()*this.get("altitude_factor"))},a.prototype.currentSpeed=function(){return r.SPEEDS[this.get("mode")][this.get("pace")]},a.prototype.currentEffort=function(){return r.EFFORT[this.get("mode")][this.get("pace")]},a.prototype.elevation_marker=function(){return this._elevation_marker||(this._elevation_marker=new google.maps.Marker({map:App.map,icon:this.elevation_icon()}))},a.prototype.elevation_icon=function(){return{anchor:new google.maps.Point(14,34),url:"img/elevation_markers/icon_"+this.get("mode")+".png"}},a.prototype.showElevationMarker=function(t){var e;return null==t&&(t=0),e=t*this.get("total_distance"),this.elevation_marker().setOptions({position:this.pointAlongPath(e),visible:!0})},a.prototype.hideElevationMarker=function(){return this.elevation_marker().setVisible(!1)},a.prototype.pointAlongPath=function(t){var e,o,n=this;return null==t&&(t=0),o=null,null!=this.polyline()&&(e=0,this.polyline().getPath().forEach(function(r,i){var p,a,s;if(i>0&&null===o){if(a=n.polyline().getPath().getAt(i-1),s=google.maps.geometry.spherical.computeDistanceBetween(a,r),!(e+s>t))return e+=s;p=(t-e)/s,o=google.maps.geometry.spherical.interpolate(a,r,p)}})),o},a.prototype.showOverlays=function(t){var e;return null!=(e=this.polyline())&&e.setMap(t),this.waypoints.each(function(e){return e.getMarker().setMap(t)})},a.prototype.hideOverlays=function(){return this.showOverlays(null)},a.prototype.polyline=function(){return this.get("encoded_polyline")?this._polyline||(this._polyline=new google.maps.Polyline({map:App.map,path:google.maps.geometry.encoding.decodePath(this.get("encoded_polyline").polyline),strokeColor:"#2564a5",strokeWeight:4,strokeOpacity:.7})):void 0},a.prototype.waypointMarkers=function(){return this.waypoints.map(function(t){var e;return e=t.getMarker()})},a.prototype.updateMap=function(){return null!=App.map?(App.map.fitBounds(this.steps.bounding_box()),this.showOverlays(App.map)):void 0},a}(n.Model)})}.call(this);